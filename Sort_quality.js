(function(){'use strict';var PLUGIN_NAME='SortByQuality';var DEFAULT_ORDER=['WebDL','WEB-DL','WEBRip','HDRip','HDTV','DVDRip','CAM'];function loadOrder(){var saved=Lampa.Storage.get(PLUGIN_NAME+'_order','[]');try{var parsed=JSON.parse(saved);if(Array.isArray(parsed)&&parsed.length)return parsed;}catch(e){}return DEFAULT_ORDER.slice()}function saveOrder(order){Lampa.Storage.set(PLUGIN_NAME+'_order',JSON.stringify(order))}function qualityIndex(title,order){for(let i=0;i<order.length;i++){if(title.toLowerCase().includes(order[i].toLowerCase()))return i}return order.length}Lampa.Listener.follow('full',function(event){if((event.type==='torent'||event.type==='online')&&event.data&&Array.isArray(event.data.results)){let order=loadOrder();event.data.results.sort(function(a,b){return qualityIndex(a.title,order)-qualityIndex(b.title,order)})}});function showSettings(){let order=loadOrder();let html='<div style="padding:1em;"><h2>Сортировка по качеству</h2><p>Перетащи качества, чтобы задать приоритет.</p><ul id="quality-list" style="list-style:none;padding:0;">';order.forEach(function(q){html+='<li style="padding:0.5em;border:1px solid #555;margin:0.3em 0;cursor:move;background:#222;border-radius:8px;">'+q+'</li>'});html+='</ul><div style="margin-top:1em;"><button class="button--yellow" id="save-quality">Сохранить</button></div></div>';Lampa.Modal.open({title:'Настройки качества',html:html,onBack:function(){Lampa.Modal.close()}});let list=document.getElementById('quality-list');let dragging;list.querySelectorAll('li').forEach(function(li){li.draggable=true;li.ondragstart=function(e){dragging=li};li.ondragover=function(e){e.preventDefault();let target=e.target.closest('li');if(target&&target!==dragging){let rect=target.getBoundingClientRect();let next=(e.clientY-rect.top)/(rect.bottom-rect.top)>0.5;list.insertBefore(dragging,next&&target.nextSibling||target)}}});document.getElementById('save-quality').onclick=function(){let newOrder=[];list.querySelectorAll('li').forEach(function(li){newOrder.push(li.innerText)});saveOrder(newOrder);Lampa.Modal.close();Lampa.Noty.show('Приоритет качества сохранён')}}Lampa.Plugin.create(PLUGIN_NAME,{start:function(){console.log(PLUGIN_NAME+' запущен');Lampa.SettingsApi.add({component:'plugins',name:PLUGIN_NAME+'_settings',type:'button',title:'Настройка сортировки качества',onChange:showSettings})},stop:function(){console.log(PLUGIN_NAME+' остановлен')}})})();
